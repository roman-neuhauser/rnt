$SHELL ${2?} $PWD/test
ex=$?

exec 3>dirstate.actual

cleanup()
{
  rm -f "$PWD/test/exit.actual"
  rm -f "$PWD/test/err.actual"
  rm -f "$PWD/test/out.actual"
  rm -f "$PWD/test/exit.diff"
  rm -f "$PWD/test/err.diff"
  rm -f "$PWD/test/out.diff"
}
trap cleanup EXIT

assert_file()
{
  if test -e "${1:?}"; then
    echo "present: $1"
  else
    echo "missing: $1"
  fi
} >&3
assert_nonexistent()
{
  assert_file ${1+"$@"}
} >&3
assert_same()
{
  diff -u "${1:?}" "${2:?}"
} >&3

assert_file "test/out.actual"
assert_file "test/err.actual"
assert_file "test/exit.actual"

assert_nonexistent "test/out.diff"
assert_file "test/err.diff"
assert_file "test/exit.diff"

assert_nonexistent "test/out.diff.tmp"
assert_nonexistent "test/err.diff.tmp"
assert_nonexistent "test/exit.diff.tmp"

assert_same "expected/exit.diff" "test/exit.diff"
assert_same "expected/err.diff" "test/err.diff"

exit $ex
